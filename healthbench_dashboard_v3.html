<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthBench Complete Evaluation Dashboard</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 32px;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-card.score-card .stat-value {
            color: #27ae60;
        }
        
        .evaluations-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .session-container {
            margin-bottom: 30px;
        }
        
        .session-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .session-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .session-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .session-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            flex-wrap: wrap;
            opacity: 0.95;
        }
        
        .session-responses {
            display: none;
        }
        
        .session-responses.expanded {
            display: block;
        }
        
        .evaluation-item {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .score-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 15px;
            color: white;
        }
        
        .score-high { background: #27ae60; }
        .score-medium { background: #f39c12; }
        .score-low { background: #e74c3c; }
        
        .timestamp {
            color: #95a5a6;
            font-size: 13px;
        }
        
        .message-box {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .message-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .message-content {
            color: #34495e;
            line-height: 1.6;
        }
        
        /* TAG SCORES SECTION */
        .tag-scores-section {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e8eaf6;
        }
        
        .section-header {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        
        .tag-score-item {
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tag-name {
            font-weight: 500;
            color: #34495e;
            text-transform: capitalize;
            font-size: 14px;
        }
        
        .tag-value {
            font-weight: bold;
            font-size: 16px;
            color: #667eea;
        }
        
        /* HELM SECTION */
        .helm-section {
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 8px;
            border: 2px solid #3498db;
        }
        
        .helm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .helm-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .helm-overall {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .helm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .helm-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .helm-item.accuracy { border-left-color: #3498db; }
        .helm-item.completeness { border-left-color: #9b59b6; }
        .helm-item.clarity { border-left-color: #1abc9c; }
        .helm-item.empathy { border-left-color: #e74c3c; }
        .helm-item.safety { border-left-color: #e67e22; }
        .helm-item.relevance { border-left-color: #27ae60; }
        
        .helm-dimension {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .helm-score {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 8px;
        }
        
        .helm-explanation {
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .metrics-summary {
            display: flex;
            gap: 25px;
            margin: 15px 0;
            flex-wrap: wrap;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .metric-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #34495e;
            font-weight: 500;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .red-flags-section {
            margin: 20px 0;
            padding: 20px;
            background: #fff5f5;
            border: 2px solid #e74c3c;
            border-radius: 8px;
        }
        
        .red-flag-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #c0392b;
        }
        
        .red-flag-severity {
            font-weight: bold;
            color: #c0392b;
            margin-bottom: 5px;
        }
        
        .toggle-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* RUBRICS SECTION */
        .rubrics-section {
            margin: 20px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .rubrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .rubric-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .rubric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        
        .rubric-card.rubric-passed {
            border-left-color: #27ae60;
            background: #f0fff4;
        }
        
        .rubric-card.rubric-failed {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }
        
        .rubric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .rubric-icon {
            font-size: 20px;
            font-weight: bold;
        }
        
        .rubric-passed .rubric-icon {
            color: #27ae60;
        }
        
        .rubric-failed .rubric-icon {
            color: #e74c3c;
        }
        
        .rubric-status {
            font-weight: 600;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .rubric-passed .rubric-status {
            background: #27ae60;
            color: white;
        }
        
        .rubric-failed .rubric-status {
            background: #e74c3c;
            color: white;
        }
        
        .rubric-criterion {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .rubric-explanation {
            color: #7f8c8d;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .rubric-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #95a5a6;
            padding-top: 10px;
            border-top: 1px solid #ecf0f1;
        }
        
        .rubric-tags {
            font-style: italic;
            color: #667eea;
        }
        
        /* COLLAPSIBLE RUBRICS STYLING */
        .rubrics-section-collapsible {
            margin: 20px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .rubrics-summary {
            cursor: pointer;
            padding: 15px;
            background: white;
            border-radius: 6px;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            transition: all 0.3s;
            user-select: none;
        }
        
        .rubrics-summary:hover {
            background: #f0f3ff;
            transform: translateX(5px);
        }
        
        .rubrics-summary::-webkit-details-marker {
            display: none;
        }
        
        .rubrics-toggle-icon {
            font-size: 14px;
            transition: transform 0.3s;
            color: #667eea;
        }
        
        details[open] .rubrics-toggle-icon {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Complete Evaluation Dashboard</h1>
            <p>All scores from backend displayed clearly - HealthBench + HELM evaluations</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Sessions</div>
                <div class="stat-value" id="total-sessions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Responses</div>
                <div class="stat-value" id="total-responses">-</div>
            </div>
            <div class="stat-card score-card">
                <div class="stat-label">Avg HealthBench Score</div>
                <div class="stat-value" id="avg-score">-</div>
            </div>
            <div class="stat-card score-card">
                <div class="stat-label">Avg HELM Score</div>
                <div class="stat-value" id="avg-helm-score">-</div>
            </div>
        </div>
        
        <div class="evaluations-section">
            <!-- Section Title with Inline Filter -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ecf0f1; flex-wrap: wrap; gap: 15px;">
                <h2 id="section-title" style="font-size: 24px; color: #2c3e50; margin: 0;">üìù All Evaluations (Click Session to Expand)</h2>
                
                <!-- Date Filter Controls -->
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <label style="font-weight: 500; color: #2c3e50; display: flex; align-items: center; gap: 6px; font-size: 14px;">
                        üìÖ
                        <input type="date" id="date-filter" onkeypress="if(event.key==='Enter') applyDateFilter()" onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'" onblur="this.style.borderColor='#ddd'; this.style.boxShadow='none'" style="padding: 6px 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; transition: all 0.3s;">
                    </label>
                    <button onclick="filterToday()" onmouseover="this.style.background='#1abc9c'" onmouseout="this.style.background='#16a085'" style="background: #16a085; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: background 0.3s;">
                        üìÜ Today
                    </button>
                    <button onclick="applyDateFilter()" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'" style="background: #667eea; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: background 0.3s;">
                        üîç Apply
                    </button>
                    <button onclick="clearDateFilter()" onmouseover="this.style.background='#7f8c8d'" onmouseout="this.style.background='#95a5a6'" style="background: #95a5a6; color: white; border: none; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 13px; transition: background 0.3s;">
                        ‚úñÔ∏è Clear
                    </button>
                </div>
            </div>
            
            <!-- Filter Status -->
            <div style="margin-bottom: 15px;">
                <span id="filter-status" style="color: #7f8c8d; font-size: 14px; font-style: italic;"></span>
            </div>
            
            <div id="evaluations-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading evaluation results...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = `http://${window.location.hostname}:8002`;
        let expandedSessions = new Set();
        let expandedRubrics = new Set();  // Track which rubrics sections are expanded
        let allSessionsData = [];  // Store all sessions for filtering
        let selectedDate = null;  // Current filter date
        
        async function loadEvaluations() {
            try {
                const response = await fetch(`${API_BASE}/healthbench/results`);
                const data = await response.json();
                
                updateStatistics(data.statistics, data.results);
                displayEvaluations(data.results);
                
            } catch (error) {
                console.error('Error loading evaluations:', error);
                document.getElementById('evaluations-container').innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Failed to load evaluations</h3>
                        <p>Make sure the backend server is running on port 8002</p>
                        <p style="color: #e74c3c; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function updateStatistics(stats, results) {
            // Count unique sessions from actual results data
            const uniqueSessions = new Set();
            let totalResponseCount = 0;
            
            if (results && results.length > 0) {
                results.forEach(r => {
                    if (r.conversation_id) {
                        uniqueSessions.add(r.conversation_id);
                    }
                    // Each result is one bot response
                    totalResponseCount++;
                });
            }
            
            // Display counts calculated from actual data
            document.getElementById('total-sessions').textContent = uniqueSessions.size || 0;
            document.getElementById('total-responses').textContent = totalResponseCount || 0;
            
            // Display averages from backend statistics
            document.getElementById('avg-score').textContent = ((stats.average_score || 0) * 100).toFixed(1) + '%';
            document.getElementById('avg-helm-score').textContent = (stats.average_helm_score || 0).toFixed(2) + '/5.0';
        }
        
        function toggleSession(session_id) {
            const content = document.getElementById(`session-${session_id}`);
            const toggle = document.getElementById(`toggle-${session_id}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('rotated');
                expandedSessions.delete(session_id);
            } else {
                content.classList.add('expanded');
                toggle.classList.add('rotated');
                expandedSessions.add(session_id);
            }
        }
        
        function handleRubricsToggle(rubricsId) {
            const detailsElement = document.getElementById(rubricsId);
            if (detailsElement) {
                if (detailsElement.open) {
                    expandedRubrics.add(rubricsId);
                } else {
                    expandedRubrics.delete(rubricsId);
                }
            }
        }
        
        function restoreRubricsState() {
            // Restore open state for rubrics sections after re-render
            expandedRubrics.forEach(rubricsId => {
                const detailsElement = document.getElementById(rubricsId);
                if (detailsElement) {
                    detailsElement.open = true;
                }
            });
        }
        
        function createEvaluationCard(result) {
            // Verify data integrity - ensure required fields exist
            if (!result.evaluation.rubric_scores || !Array.isArray(result.evaluation.rubric_scores)) {
                console.warn('Missing rubric_scores for evaluation:', result.id);
                result.evaluation.rubric_scores = [];
            }
            
            if (!result.evaluation.metrics) {
                console.warn('Missing metrics for evaluation:', result.id);
                result.evaluation.metrics = {
                    rubrics_passed: 0,
                    num_rubrics_evaluated: 0,
                    rubrics_failed: 0
                };
            }
            
            const score = result.evaluation.overall_score;
            const scoreClass = score >= 0.8 ? 'score-high' : score >= 0.6 ? 'score-medium' : 'score-low';
            
            // Tag Scores Section
            let tagScoresHtml = '';
            if (result.evaluation.tag_scores) {
                tagScoresHtml = `
                    <div class="tag-scores-section">
                        <div class="section-header">üìä Tag Scores (All Categories)</div>
                        <div class="tag-scores-grid">
                            ${Object.entries(result.evaluation.tag_scores).map(([tag, value]) => `
                                <div class="tag-score-item">
                                    <span class="tag-name">${tag}</span>
                                    <span class="tag-value">${(value * 100).toFixed(1)}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // HELM Scores Section (all 6 dimensions)
            let helmHtml = '';
            if (result.evaluation.helm) {
                const helm = result.evaluation.helm;
                helmHtml = `
                    <div class="helm-section">
                        <div class="helm-header">
                            <div class="helm-title">üéØ HELM Evaluation (6 Dimensions)</div>
                            <div class="helm-overall">Overall: ${helm.overall_helm_score.toFixed(2)}/5.0</div>
                        </div>
                        <div class="helm-grid">
                            <div class="helm-item accuracy">
                                <div class="helm-dimension">Accuracy</div>
                                <div class="helm-score">${helm.accuracy_score}/5</div>
                                <div class="helm-explanation">${escapeHtml(helm.accuracy_explanation || 'N/A')}</div>
                            </div>
                            <div class="helm-item completeness">
                                <div class="helm-dimension">Completeness</div>
                                <div class="helm-score">${helm.completeness_score}/5</div>
                                <div class="helm-explanation">${escapeHtml(helm.completeness_explanation || 'N/A')}</div>
                            </div>
                            <div class="helm-item clarity">
                                <div class="helm-dimension">Clarity</div>
                                <div class="helm-score">${helm.clarity_score}/5</div>
                                <div class="helm-explanation">${escapeHtml(helm.clarity_explanation || 'N/A')}</div>
                            </div>
                            ${helm.empathy_score ? `
                                <div class="helm-item empathy">
                                    <div class="helm-dimension">Empathy</div>
                                    <div class="helm-score">${helm.empathy_score}/5</div>
                                    <div class="helm-explanation">${escapeHtml(helm.empathy_explanation || 'N/A')}</div>
                                </div>
                            ` : ''}
                            ${helm.safety_score ? `
                                <div class="helm-item safety">
                                    <div class="helm-dimension">Safety</div>
                                    <div class="helm-score">${helm.safety_score}/5</div>
                                    <div class="helm-explanation">${escapeHtml(helm.safety_explanation || 'N/A')}</div>
                                </div>
                            ` : ''}
                            ${helm.relevance_score ? `
                                <div class="helm-item relevance">
                                    <div class="helm-dimension">Relevance</div>
                                    <div class="helm-score">${helm.relevance_score}/5</div>
                                    <div class="helm-explanation">${escapeHtml(helm.relevance_explanation || 'N/A')}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Red Flags Section
            let redFlagsHtml = '';
            if (result.evaluation.red_flags && result.evaluation.red_flags.length > 0) {
                redFlagsHtml = `
                    <div class="red-flags-section">
                        <div class="section-header">üö© Red Flags Detected (${result.evaluation.red_flags.length})</div>
                        ${result.evaluation.red_flags.map(flag => `
                            <div class="red-flag-item">
                                <div class="red-flag-severity">[${flag.severity}] ${escapeHtml(flag.criterion)}</div>
                                <div>${escapeHtml(flag.explanation)}</div>
                                <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">Points deducted: ${flag.points_deducted}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Rubrics Section (All 13 Rubrics - Passed/Failed) - COLLAPSIBLE
            let rubricsHtml = '';
            if (result.evaluation.rubric_scores && result.evaluation.rubric_scores.length > 0) {
                // Use backend metrics for accurate counts (how backend scored them)
                const totalRubrics = result.evaluation.metrics.num_rubrics_evaluated;
                const passedCount = result.evaluation.metrics.rubrics_passed;
                const failedCount = result.evaluation.metrics.rubrics_failed;
                
                const rubricsId = `rubrics-${result.id}`;
                
                rubricsHtml = `
                    <details class="rubrics-section-collapsible" id="${rubricsId}" style="margin: 20px 0;" ontoggle="handleRubricsToggle('${rubricsId}')">
                        <summary class="rubrics-summary">
                            <span class="rubrics-toggle-icon">‚ñ∂</span>
                            <strong>üìã All Rubrics (${totalRubrics} Total: ${passedCount} Passed ‚úì, ${failedCount} Failed ‚úó)</strong>
                            <span style="font-size: 12px; color: #95a5a6; margin-left: 10px;">Click to expand/collapse</span>
                        </summary>
                        <div class="rubrics-grid" style="margin-top: 15px;">
                            ${result.evaluation.rubric_scores.map(rubric => {
                                // Determine if rubric passed based on backend logic:
                                // - Positive rubrics (is_positive=true): criteria_met=true means PASSED
                                // - Negative rubrics (is_positive=false): criteria_met=false means PASSED (bad thing didn't happen)
                                const isPassed = rubric.is_positive ? rubric.criteria_met : !rubric.criteria_met;
                                
                                return `
                                <div class="rubric-card ${isPassed ? 'rubric-passed' : 'rubric-failed'}">
                                    <div class="rubric-header">
                                        <span class="rubric-icon">${isPassed ? '‚úì' : '‚úó'}</span>
                                        <span class="rubric-status">${isPassed ? 'PASSED' : 'FAILED'}</span>
                                    </div>
                                    <div class="rubric-criterion">${escapeHtml(rubric.criterion)}</div>
                                    <div class="rubric-explanation">${escapeHtml(rubric.explanation)}</div>
                                    <div class="rubric-footer">
                                        <span>Points: ${rubric.points}</span>
                                        ${rubric.tags ? `<span class="rubric-tags">${rubric.tags.join(', ')}</span>` : ''}
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </details>
                `;
            }
            
            return `
                <div class="evaluation-item">
                    <div class="evaluation-header">
                        <div>
                            <span class="score-badge ${scoreClass}">HealthBench: ${(score * 100).toFixed(1)}%</span>
                            ${result.evaluation.helm ? `<span class="score-badge" style="background:#3498db;">HELM: ${result.evaluation.helm.overall_helm_score.toFixed(2)}/5</span>` : ''}
                        </div>
                        <div class="timestamp">${new Date(result.timestamp).toLocaleString()}</div>
                    </div>
                    
                    <div class="message-box">
                        <div class="message-label">üë§ User Message:</div>
                        <div class="message-content">${escapeHtml(result.user_message)}</div>
                    </div>
                    
                    <div class="message-box" style="border-left-color: #667eea;">
                        <div class="message-label">ü§ñ Bot Response:</div>
                        <div class="message-content">${escapeHtml(result.bot_response)}</div>
                    </div>
                    
                    <div class="metrics-summary">
                        <div class="metric-item">
                            üìã <strong>${result.evaluation.metrics.rubrics_passed}/${result.evaluation.metrics.num_rubrics_evaluated}</strong> rubrics passed
                        </div>
                        <div class="metric-item">
                            üõ°Ô∏è Safety: <strong>${(result.evaluation.safety_score * 100).toFixed(1)}%</strong>
                        </div>
                        <div class="metric-item">
                            ‚è±Ô∏è Eval time: <strong>${result.evaluation.evaluation_time.toFixed(2)}s</strong>
                        </div>
                        <div class="metric-item" style="color: #95a5a6; font-size: 12px;">
                            üìä Overall: <strong>${(result.evaluation.overall_score * 100).toFixed(1)}%</strong>
                        </div>
                    </div>
                    
                    <!-- HealthBench Evaluation Summary Panel -->
                    <div style="margin: 15px 0; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px; font-size: 13px;">
                        <strong style="color: #2e7d32;">‚úÖ HealthBench Evaluation:</strong><br>
                        <span style="color: #666;">Overall Score: ${result.evaluation.overall_score.toFixed(2)} (${result.evaluation.metrics.rubrics_passed}/${result.evaluation.metrics.num_rubrics_evaluated} passed)</span><br>
                        <span style="color: #666;">Safety Score: ${result.evaluation.safety_score.toFixed(2)}</span><br>
                        <span style="color: #666;">Tag Scores: ${Object.entries(result.evaluation.tag_scores || {}).map(([tag, score]) => `${tag}: ${score.toFixed(2)}`).join(', ')}</span>
                    </div>
                    
                    ${tagScoresHtml}
                    ${helmHtml}
                    ${redFlagsHtml}
                    ${rubricsHtml}
                </div>
            `;
        }
        
        function applyDateFilter() {
            const dateInput = document.getElementById('date-filter');
            if (!dateInput.value) {
                alert('Please select a date first');
                return;
            }
            
            selectedDate = dateInput.value;
            displayEvaluations(allSessionsData);
            
            // Update filter status
            const filterStatus = document.getElementById('filter-status');
            const matchedSessions = filterSessionsByDate(allSessionsData, selectedDate);
            filterStatus.textContent = `Showing ${Object.keys(matchedSessions).length} session(s) from ${selectedDate}`;
            filterStatus.style.color = '#27ae60';
            filterStatus.style.fontWeight = '600';
        }
        
        function clearDateFilter() {
            selectedDate = null;
            document.getElementById('date-filter').value = '';
            displayEvaluations(allSessionsData);
            
            // Update filter status
            const filterStatus = document.getElementById('filter-status');
            filterStatus.textContent = 'Showing all sessions';
            filterStatus.style.color = '#7f8c8d';
            filterStatus.style.fontWeight = 'normal';
        }
        
        function filterToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-filter').value = today;
            selectedDate = today;
            displayEvaluations(allSessionsData);
            
            // Update filter status
            const filterStatus = document.getElementById('filter-status');
            const matchedSessions = filterSessionsByDate(allSessionsData, selectedDate);
            const count = Object.keys(matchedSessions).length;
            filterStatus.textContent = count > 0 
                ? `Showing ${count} session(s) from today` 
                : 'No sessions found for today';
            filterStatus.style.color = count > 0 ? '#27ae60' : '#e74c3c';
            filterStatus.style.fontWeight = '600';
        }
        
        function filterSessionsByDate(results, dateStr) {
            if (!dateStr || !results || results.length === 0) {
                // Group all sessions
                const sessions = {};
                results.forEach(result => {
                    const session_id = result.conversation_id || 'unknown';
                    if (!sessions[session_id]) {
                        sessions[session_id] = [];
                    }
                    sessions[session_id].push(result);
                });
                return sessions;
            }
            
            // Filter by date
            const sessions = {};
            results.forEach(result => {
                const resultDate = new Date(result.timestamp).toISOString().split('T')[0];
                if (resultDate === dateStr) {
                    const session_id = result.conversation_id || 'unknown';
                    if (!sessions[session_id]) {
                        sessions[session_id] = [];
                    }
                    sessions[session_id].push(result);
                }
            });
            return sessions;
        }
        
        function displayEvaluations(results) {
            const container = document.getElementById('evaluations-container');
            
            // Store data for filtering
            allSessionsData = results;
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üìù No evaluations yet</h3>
                        <p>Start a conversation to see results</p>
                    </div>
                `;
                return;
            }
            
            // Group by session (with optional date filter)
            const sessions = filterSessionsByDate(results, selectedDate);
            
            if (Object.keys(sessions).length === 0 && selectedDate) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üìÖ No sessions found for ${selectedDate}</h3>
                        <p>Try a different date or clear the filter</p>
                    </div>
                `;
                return;
            }
            
            // Sort sessions by most recent
            const sortedSessions = Object.entries(sessions).sort((a, b) => {
                const timeA = new Date(a[1][a[1].length - 1].timestamp);
                const timeB = new Date(b[1][b[1].length - 1].timestamp);
                return timeB - timeA;
            });
            
            container.innerHTML = '';
            
            // Update section title with count
            const sectionTitle = document.getElementById('section-title');
            if (selectedDate) {
                sectionTitle.textContent = `üìù Filtered Evaluations (${sortedSessions.length} session${sortedSessions.length !== 1 ? 's' : ''} on ${selectedDate})`;
            } else {
                sectionTitle.textContent = `üìù All Evaluations (${sortedSessions.length} session${sortedSessions.length !== 1 ? 's' : ''} total - Click to Expand)`;
            }
            
            sortedSessions.forEach(([session_id, sessionResults], index) => {
                const avgScore = sessionResults.reduce((sum, r) => sum + r.evaluation.overall_score, 0) / sessionResults.length;
                const avgSafety = sessionResults.reduce((sum, r) => sum + (r.evaluation.safety_score || 0), 0) / sessionResults.length;
                const hasHelm = sessionResults.some(r => r.evaluation.helm);
                const avgHelm = hasHelm ? sessionResults.filter(r => r.evaluation.helm).reduce((sum, r) => sum + r.evaluation.helm.overall_helm_score, 0) / sessionResults.filter(r => r.evaluation.helm).length : 0;
                const firstTime = new Date(sessionResults[0].timestamp);
                const lastTime = new Date(sessionResults[sessionResults.length - 1].timestamp);
                
                // Calculate session duration
                const durationMs = lastTime - firstTime;
                const durationMinutes = Math.floor(durationMs / 60000);
                const durationSeconds = Math.floor((durationMs % 60000) / 1000);
                const durationDisplay = durationMinutes > 0 
                    ? `${durationMinutes}m ${durationSeconds}s` 
                    : `${durationSeconds}s`;
                
                // Create user-friendly session number (most recent = #1)
                const sessionNumber = index + 1;
                
                // Extract short date/time for quick identification
                const shortDate = firstTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const shortTime = firstTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                const sessionHtml = `
                    <div class="session-container">
                        <div class="session-header" onclick="toggleSession('${session_id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div class="session-title">
                                        <span style="background: white; color: #667eea; padding: 4px 12px; border-radius: 20px; font-weight: bold; margin-right: 10px;">Session #${sessionNumber}</span>
                                        <span style="color: rgba(255,255,255,0.9); font-size: 16px;">${shortDate} at ${shortTime}</span>
                                        <span style="color: rgba(255,255,255,0.7); font-size: 12px; margin-left: 10px;">(${session_id})</span>
                                    </div>
                                    <div class="session-meta">
                                        <span>üìù ${sessionResults.length} response${sessionResults.length > 1 ? 's' : ''}</span>
                                        <span>‚è±Ô∏è Duration: ${durationDisplay}</span>
                                        <span>üìä Avg HealthBench: ${(avgScore * 100).toFixed(1)}%</span>
                                        ${hasHelm ? `<span>üéØ Avg HELM: ${avgHelm.toFixed(2)}/5.0</span>` : ''}
                                    </div>
                                </div>
                                <div id="toggle-${session_id}" class="toggle-icon">‚ñº</div>
                            </div>
                        </div>
                        
                        <div id="session-${session_id}" class="session-responses ${expandedSessions.has(session_id) ? 'expanded' : ''}">
                            ${sessionResults.map(result => createEvaluationCard(result)).join('')}
                        </div>
                    </div>
                `;
                
                container.innerHTML += sessionHtml;
            });
            
            // Restore rubrics expanded state after re-render
            setTimeout(() => {
                restoreRubricsState();
            }, 100);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load evaluations on page load
        loadEvaluations();
        
        // Set initial filter status
        document.getElementById('filter-status').textContent = 'Showing all sessions';
        
        // Auto-refresh every 15 seconds
        setInterval(loadEvaluations, 15000);
    </script>
</body>
</html>

